<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generar Reportes PDF - Intralaboral Forma A</title>
    <link rel="icon" type="image/x-icon" href="/cuestionarios/assets/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/cuestionarios/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            overflow-y: auto !important;
        }

        .pdf-generator-app {
            min-height: 100vh;
            padding: var(--spacing-xl);
            max-width: 1200px;
            margin: 0 auto;
        }

        .pdf-header {
            text-align: center;
            margin-bottom: var(--spacing-2xl);
            padding: var(--spacing-xl);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }

        .pdf-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
        }

        .pdf-title {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .pdf-subtitle {
            color: var(--text-secondary);
            font-size: var(--font-size-lg);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            color: var(--primary-color);
            text-decoration: none;
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-lg);
            font-weight: 600;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .search-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
        }

        .search-section h2 {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .search-box {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .search-box input {
            flex: 1;
            padding: var(--spacing-md) var(--spacing-lg);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: var(--font-size-md);
            font-family: var(--font-family);
            transition: all var(--transition-fast);
            background: var(--bg-main);
            color: var(--text-primary);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .btn {
            padding: var(--spacing-md) var(--spacing-xl);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-md);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-family: var(--font-family);
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .actions-section {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .results-info {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.1));
            border-left: 4px solid var(--primary-color);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
        }

        .results-info p {
            margin: var(--spacing-xs) 0;
            color: var(--text-primary);
            font-weight: 500;
        }

        .response-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            transition: all var(--transition-fast);
        }

        .response-card:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--spacing-md);
        }

        .response-info {
            flex: 1;
        }

        .cedula-badge {
            background: var(--primary-gradient);
            color: white;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-full);
            font-weight: 600;
            font-size: var(--font-size-md);
            display: inline-block;
            margin-bottom: var(--spacing-xs);
        }

        .date-text {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        .response-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .btn-small {
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: var(--font-size-sm);
        }

        .loading {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-md);
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #ef4444;
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            color: #dc2626;
            margin-bottom: var(--spacing-md);
        }

        .success {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid #10b981;
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            color: #059669;
            margin-bottom: var(--spacing-md);
        }

        @media (max-width: 768px) {
            .pdf-generator-app {
                padding: var(--spacing-md);
            }

            .pdf-title {
                font-size: var(--font-size-xl);
            }

            .search-box {
                flex-direction: column;
            }

            .actions-section {
                flex-direction: column;
            }

            .response-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* === ESTILOS GESTI√ìN DE PDFS (DEFINITIVO) === */

        /* Contenedor tipo Tarjeta */
        .manage-pdfs-section {
            background-color: #ffffff !important;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: block;
        }

        .manage-pdfs-section.hidden {
            display: none !important;
        }

        /* Cabecera */
        .manage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            gap: var(--spacing-md);
        }

        .manage-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* Controles */
        .table-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .bulk-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-left: 1rem;
            border-left: 1px solid var(--border-color);
            opacity: 0.5;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .bulk-actions.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Tabla */
        .table-container {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
            background: #fff;
        }

        .file-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .file-table th {
            background-color: #f8fafc;
            font-weight: 600;
            text-align: left;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .file-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            vertical-align: middle;
        }

        .file-table tr:last-child td {
            border-bottom: none;
        }

        .file-table tr:hover {
            background-color: #f1f5f9;
        }

        /* Checkbox y Acciones */
        .checkbox-cell {
            width: 40px;
            text-align: center;
        }

        .file-actions {
            display: flex;
            gap: 0.5rem;
        }
    </style>
</head>

<body>
    <!-- Background Animation -->
    <div class="bg-animation">
        <div class="bg-gradient"></div>
        <div class="floating-shapes">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
            <div class="shape shape-3"></div>
            <div class="shape shape-4"></div>
        </div>
    </div>

    <div class="pdf-generator-app">
        <a href="/cuestionarios/resultados-dashboard" class="back-link">
            ‚Üê Volver al Dashboard
        </a>

        <div class="pdf-header">
            <div class="pdf-icon">üñ®Ô∏è</div>
            <h1 class="pdf-title">Generar Reportes PDF</h1>
            <p class="pdf-subtitle">Cuestionario de Factores Psicosociales Intralaborales Form B</p>
        </div>

        <!-- Secci√≥n de b√∫squeda -->
        <div class="search-section">
            <h2>üîç Buscar por C√©dula</h2>
            <div class="search-box">
                <input type="text" id="cedulaInput" placeholder="Ingrese el n√∫mero de c√©dula..."
                    onkeypress="if(event.key === 'Enter') searchByCedula()">
                <button class="btn btn-primary" onclick="searchByCedula()">
                    üîç Buscar
                </button>
            </div>
            <div id="searchResults"></div>
        </div>

        <!-- Secci√≥n de acciones generales -->
        <div class="search-section">
            <h2>üìÑ Acciones Generales</h2>
            <div class="actions-section">
                <button class="btn btn-secondary" onclick="loadAllResponses()">
                    üìã Ver Todas las Respuestas
                </button>
                <button class="btn btn-danger" onclick="generateAllPDFs()">
                    üñ®Ô∏è Generar PDFs de Todos
                </button>
                <button class="btn btn-secondary" onclick="togglePDFSection()" style="background: var(--text-primary);">
                    üìÇ Ver PDFs Generados
                </button>
            </div>
            <div id="progressContainer" style="display: none; margin-top: var(--spacing-lg);">
                <div class="results-info" style="border-left-color: var(--primary-color);">
                    <p id="progressText">Generando PDFs: 0%</p>
                    <div
                        style="width: 100%; height: 10px; background: #eee; border-radius: 5px; margin-top: 10px; overflow: hidden;">
                        <div id="progressBar"
                            style="width: 0%; height: 100%; background: var(--primary-color); transition: width 0.3s;">
                        </div>
                    </div>
                </div>
            </div>
            <div id="allResponsesContainer" style="margin-top: var(--spacing-lg);"></div>
        </div>
        <!-- Secci√≥n de Gesti√≥n de PDFs (Tabla Avanzada) -->
        <div class="manage-pdfs-section hidden">
            <div class="manage-header">
                <div class="manage-title">
                    üìÇ Gestionar Archivos de Reporte
                </div>
                <div class="table-controls">
                    <button class="btn btn-secondary btn-small" onclick="loadPDFList()">
                        üîÑ Refrescar Lista
                    </button>
                    <div id="bulkActions" class="bulk-actions">
                        <button class="btn btn-primary btn-small" onclick="downloadSelected()">
                            ‚¨áÔ∏è Descargar Seleccionados (ZIP)
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteSelected()"
                            style="background: #dc2626;">
                            üóëÔ∏è Borrar Seleccionados
                        </button>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <div id="pdfListContainer"></div>
            </div>
            <div id="selectionStatus" style="margin-top: 10px; color: var(--text-secondary); font-size: 0.9em;">
                0 archivos seleccionados
            </div>
        </div>
    </div>

    <!-- Template oculto para generaci√≥n de PDF -->
    <iframe id="pdfFrame" style="display: none;"></iframe>



    <script>
        const API_BASE_URL = '/cuestionarios';
        let allResponses = [];
        let questionnaireData = null;

        // Cargar datos del cuestionario
        async function loadQuestionnaireData() {
            try {
                // Fetch from API instead of static JSON file
                const response = await fetch(`${API_BASE_URL}/api/questionnaires/intralaborales-b`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                questionnaireData = await response.json();
            } catch (error) {
                console.error('Error loading questionnaire:', error);
            }
        }

        // Buscar por c√©dula
        async function searchByCedula() {
            const cedula = document.getElementById('cedulaInput').value.trim();
            const resultsContainer = document.getElementById('searchResults');

            if (!cedula) {
                resultsContainer.innerHTML = '<div class="error">Por favor ingrese un n√∫mero de c√©dula.</div>';
                return;
            }

            resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div>Buscando...</div>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/responses/intralaborales-b`);
                const responseData = await response.json();
                const allData = responseData.responses;

                const userResponse = allData.find(r => r.respondent_cedula === cedula);

                if (userResponse) {
                    resultsContainer.innerHTML = `
                        <div class="success">‚úÖ Usuario encontrado</div>
                        ${renderResponseCard(userResponse)}
                    `;
                } else {
                    resultsContainer.innerHTML = `<div class="error">‚ùå No se encontraron resultados para la c√©dula: ${cedula}</div>`;
                }
            } catch (error) {
                resultsContainer.innerHTML = `<div class="error">Error al buscar: ${error.message}</div>`;
            }
        }

        // Cargar todas las respuestas
        async function loadAllResponses() {
            // Ocultar secci√≥n de PDFs si est√° visible
            const pdfSection = document.querySelector('.manage-pdfs-section');
            if (pdfSection) pdfSection.classList.add('hidden');

            const container = document.getElementById('allResponsesContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Cargando respuestas...</div>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/responses/intralaborales-b`);
                const responseData = await response.json();
                allResponses = responseData.responses;

                if (allResponses.length === 0) {
                    container.innerHTML = '<div class="error">No hay respuestas disponibles.</div>';
                    return;
                }

                let html = `<div class="results-info">
                    <p><strong>Total de respuestas:</strong> ${allResponses.length}</p>
                </div>`;

                allResponses.forEach(response => {
                    html += renderResponseCard(response);
                });

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">Error al cargar respuestas: ${error.message}</div>`;
            }
        }

        // Renderizar tarjeta de respuesta
        function renderResponseCard(response) {
            const date = new Date(response.submitted_at).toLocaleString('es-CO');

            return `
                <div class="response-card">
                    <div class="response-header">
                        <div class="response-info">
                            <div class="cedula-badge">CC: ${response.respondent_cedula}</div>
                            <div class="date-text">${date}</div>
                        </div>
                        <div class="response-actions">
                            <button class="btn btn-primary btn-small" onclick='generatePDF(${JSON.stringify(response)})'>
                                üñ®Ô∏è Imprimir
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Generar PDF individual
        function generatePDF(responseData) {
            const iframe = document.getElementById('pdfFrame');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

            // Generar el HTML del reporte
            generateReportHTML(responseData).then(reportHTML => {
                // Cargar el HTML en el iframe
                iframeDoc.open();
                iframeDoc.write(reportHTML);
                iframeDoc.close();

                // Esperar a que el iframe cargue e imprimir
                iframe.onload = function () {
                    setTimeout(() => {
                        iframe.contentWindow.print();
                    }, 500);
                };
            });
        }

        // Convierte una URL de imagen a base64 data URI
        async function imgToBase64(url) {
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error('Failed to fetch image');
                const blob = await res.blob();
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });
            } catch (e) {
                return ''; // Retornar vac√≠o si falla
            }
        }

        // Generar PDF en el servidor
        async function generateAndSavePDFToServer(responseData) {
            // Generar el HTML del reporte
            let reportHTML = await generateReportHTML(responseData);

            // Convertir im√°genes a base64 (Backend necesita contenido embebido)
            const colombiaB64 = await imgToBase64('/cuestionarios/escudo_colombia.png');
            const javerianaB64 = await imgToBase64('/cuestionarios/logo_javeriana.png');
            reportHTML = reportHTML
                .replace(/src="\/cuestionarios\/escudo_colombia\.png"/g, `src="${colombiaB64}"`)
                .replace(/src="\/cuestionarios\/logo_javeriana\.png"/g, `src="${javerianaB64}"`);

            const filename = `Reporte_Intralaboral_B_${responseData.respondent_cedula}.pdf`;

            const response = await fetch(`${API_BASE_URL}/api/generate-pdf-server`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ html: reportHTML, filename })
            });

            if (!response.ok) {
                const err = await response.text();
                throw new Error(`Error del servidor: ${err}`);
            }

            const result = await response.json();
            return result.success;
        }

        // Generar todos los PDFs y guardarlos en el servidor
        async function generateAllPDFs() {
            if (allResponses.length === 0) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/responses/intralaborales-b`);
                    const responseData = await response.json();
                    allResponses = responseData.responses;

                    if (allResponses.length === 0) {
                        alert('No hay respuestas disponibles para generar reportes.');
                        return;
                    }
                } catch (error) {
                    alert('Error al cargar las respuestas: ' + error.message);
                    return;
                }
            }

            if (!confirm(`¬øEst√° seguro de generar y guardar ${allResponses.length} reportes PDF directamente en el servidor?`)) {
                return;
            }

            const progressContainer = document.getElementById('progressContainer');
            const progressText = document.getElementById('progressText');
            const progressBar = document.getElementById('progressBar');

            progressContainer.style.display = 'block';
            let successCount = 0;

            for (let i = 0; i < allResponses.length; i++) {
                try {
                    const percent = Math.round(((i + 1) / allResponses.length) * 100);
                    progressText.innerText = `Generando y guardando PDFs: ${percent}% (${i + 1}/${allResponses.length})`;
                    progressBar.style.width = `${percent}%`;

                    await generateAndSavePDFToServer(allResponses[i]);
                    successCount++;
                } catch (error) {
                    console.error(`Error en respuesta ${i}:`, error);
                }
            }

            progressText.innerText = `‚úÖ ¬°Completado! Se guardaron ${successCount} reportes en el servidor.`;
            alert(`Se han generado y guardado ${successCount} reportes PDF en la carpeta del servidor.`);
        }


        // Generar HTML del reporte
        async function generateReportHTML(responseData) {
            // Usar preguntas cargadas o fallback
            const questions = (questionnaireData && questionnaireData.questions) ? questionnaireData.questions : [];

            // Cargar imagen de instrucciones
            const instruccionesB64 = await imgToBase64('/cuestionarios/instrucciones.png');

            // Crear objeto de respuestas
            const responsesMap = {};
            responseData.responses.forEach(r => {
                responsesMap[r.question_id] = r.response_value;
            });

            // Obtener fecha de aplicaci√≥n
            const submissionDate = new Date(responseData.submitted_at);
            const day = String(submissionDate.getDate()).padStart(2, '0');
            const month = String(submissionDate.getMonth() + 1).padStart(2, '0');
            const year = submissionDate.getFullYear();

            // Map sections to start IDs
            const sectionMap = {};
            if (questionnaireData && questionnaireData.sections) {
                questionnaireData.sections.forEach(sec => {
                    if (sec.questions && sec.questions.length > 0 && sec.message) {
                        sectionMap[sec.questions[0]] = sec.message;
                    }
                });
            }

            // Funci√≥n helper para generar filas
            const generateRows = (start, end) => {
                let html = '';
                let tableOpen = false;

                const openTable = () => {
                    if (!tableOpen) {
                        html += tableHeaderHTML;
                        tableOpen = true;
                    }
                };

                const closeTable = () => {
                    if (tableOpen) {
                        html += '</tbody></table>';
                        tableOpen = false;
                    }
                };

                questions.slice(start, end).forEach(q => {
                    if (sectionMap[q.id]) {
                        closeTable();
                        html += `<div class="instructions-text" style="margin-top: 1.5rem; margin-bottom: 0.5rem; font-weight: normal;">${sectionMap[q.id]}</div>`;
                        openTable();
                    } else {
                        openTable();
                    }

                    const response = responsesMap[q.id];
                    html += `
                        <tr>
                            <td class="question-id">${q.id}</td>
                            <td class="question-cell" style="font-size: 11pt;">${q.text}</td>
                            <td class="response-cell">${response === 1 ? 'X' : ''}</td>
                            <td class="response-cell">${response === 2 ? 'X' : ''}</td>
                            <td class="response-cell">${response === 3 ? 'X' : ''}</td>
                            <td class="response-cell">${response === 4 ? 'X' : ''}</td>
                            <td class="response-cell">${response === 5 ? 'X' : ''}</td>
                        </tr>
                    `;
                });

                closeTable();
                return html;
            };

            const headerHTML = `
                <div class="header">
                    <div class="logo-left">
                        <img src="/cuestionarios/escudo_colombia.png" alt="Escudo de Colombia">
                        <div class="logo-text">
                            <strong>Ministerio de la Protecci√≥n Social</strong>
                            Rep√∫blica de Colombia
                        </div>
                    </div>
                    <div class="logo-right">
                        <img src="/cuestionarios/logo_javeriana.png" alt="Logo Javeriana">
                    </div>
                </div>
            `;

            const tableHeaderHTML = `
                <table class="questionnaire-table" style="margin-top: 1.5rem;">
                    <thead>
                        <tr>
                            <th colspan="2" style="background: transparent; border: none;"></th>
                            <th style="width: 10%;">Siempre</th>
                            <th style="width: 10%;">Casi<br>siempre</th>
                            <th style="width: 10%;">Algunas<br>veces</th>
                            <th style="width: 10%;">Casi<br>nunca</th>
                            <th style="width: 10%;">Nunca</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // P√°ginas 1-8 (Preguntas 1-88)
            // Page 1: 1-12
            const page1Rows = generateRows(0, 12);
            // Page 2: 13-20
            const page2Rows = generateRows(12, 20);
            // Page 3: 21-37
            const page3Rows = generateRows(20, 37);
            // Page 4: 38-48
            const page4Rows = generateRows(37, 48);
            // Page 5: 49-61
            const page5Rows = generateRows(48, 61);
            // Page 6: 62-75
            const page6Rows = generateRows(61, 75);
            // Page 7: 76-88
            const page7Rows = generateRows(75, 88);

            // Conditional Sections Data
            // Check if direct response exists OR if there are answers in the conditional range (89-97)
            const hasClientAnswers = questions.slice(88, 97).some(q => responsesMap[q.id]);
            const atiendeClientes = responsesMap['atiende_clientes'] === 'si' || hasClientAnswers;

            // Form B does not have "Colaboradores" (Chief) section

            // Conditional Tables
            let clientesRows = '';
            // Questions 89-97 (Index 88-97)
            questions.slice(88, 97).forEach(q => {
                const response = responsesMap[q.id];
                clientesRows += `
                    <tr>
                        <td class="question-id">${q.id}</td>
                        <td class="question-cell" style="font-size: 11pt;">${q.text}</td>
                        <td class="response-cell">${response === 1 ? 'X' : ''}</td>
                        <td class="response-cell">${response === 2 ? 'X' : ''}</td>
                        <td class="response-cell">${response === 3 ? 'X' : ''}</td>
                        <td class="response-cell">${response === 4 ? 'X' : ''}</td>
                        <td class="response-cell">${response === 5 ? 'X' : ''}</td>
                    </tr>
                `;
            });

            // Old colaboradores logic removed

            // --- HTML Structure ---

            // Conditional 1 Block
            const conditional1Block = `
                <div class="conditional-section" style="margin-top: 3rem;">
                    <div class="instructions-text">
                        Las siguientes preguntas est√°n relacionadas con la atenci√≥n a clientes y usuarios.
                    </div>
                    
                    <div class="conditional-question-box">
                        <div class="cond-text" style="flex: 1;">En mi trabajo debo brindar servicio a clientes o usuarios:</div>
                        <div class="cond-options">
                            <div class="cond-opt">Si <div class="cond-box">${atiendeClientes ? 'X' : ''}</div></div>
                            <div class="cond-opt">No <div class="cond-box">${!atiendeClientes ? 'X' : ''}</div></div>
                        </div>
                    </div>
                    
                    <div class="instructions-text" style="font-size: 9pt; margin-top: 10px; margin-bottom: 20px;">
                        Si su respuesta fue SI por favor responda las siguientes preguntas. Si su respuesta fue NO pase a las preguntas de la p√°gina siguiente.
                    </div>

                    ${true ? `
                        <table class="questionnaire-table">
                            <thead>
                                <tr>
                                    <th colspan="2" style="background: transparent; border: none;"></th>
                                    <th style="width: 10%;">Siempre</th>
                                    <th style="width: 10%;">Casi<br>siempre</th>
                                    <th style="width: 10%;">Algunas<br>veces</th>
                                    <th style="width: 10%;">Casi<br>nunca</th>
                                    <th style="width: 10%;">Nunca</th>
                                </tr>
                            </thead>
                            <tbody>${clientesRows}</tbody>
                        </table>
                    ` : ''}
                </div>
            `;


            // Form B only has Conditional 1 Block (Clientes)
            // Conditional 2 Block REMOVED for Form B



            return `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte - CC: ${responseData.respondent_cedula}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        @page {
            size: letter;
            margin: 0.4in;
            margin-header: 0;
            margin-footer: 0;
        }

        body {
            font-family: 'Arial', sans-serif;
            font-size: 11pt;
            line-height: 1.3;
            color: #000;
            background: white;
            width: 100%;
            padding: 0.4in;
        }

        /* Estilos Car√°tula */
        .cover-page {
            height: 23cm;
            display: flex;
            flex-direction: column;
            page-break-after: always;
            padding-top: 0.5cm;
        }

        .cover-header {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-bottom: 2cm;
        }

        .cover-data-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .cover-data-label {
            font-size: 10pt;
            text-align: right;
            width: 180px;
        }

        .date-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .box {
            border: 1pt solid #000;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10pt;
        }

        .day-box, .month-box { width: 30px; }
        .year-box { width: 60px; }
        .id-box { width: 120px; }

        .box-sublabel {
            font-size: 7pt;
            color: #666;
            margin-top: 2px;
        }

        .cover-main {
            margin-top: 2cm;
            margin-bottom: 2cm;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .green-title {
            color: #2e7d32; /* Green like Extralaboral */
            font-size: 15pt;
            font-weight: 800;
            text-transform: uppercase;
            line-height: 1.4;
            max-width: 100%;
        }

        .cover-footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: auto;
            padding-bottom: 0.5cm;
        }

        .footer-logo-left {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding-left: 2cm;
        }

        .footer-logo-left img {
            height: 130px;
            margin-bottom: 5px;
        }

        .footer-logo-left span {
            font-size: 9pt;
            font-weight: bold;
            line-height: 1.1;
        }

        .footer-logo-right img {
            height: 126px;
        }
        
        /* Instrucciones y Contenido */
        .instructions-page-img {
            page-break-after: always;
            display: flex;
            flex-direction: column;
            height: 23cm;
        }
        
        .instructions-page-img img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .content-page {
            padding-top: 0.5cm;
            page-break-after: always;
        }

        .content-page:last-child {
            page-break-after: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
            padding-bottom: 5px;
        }

        .logo-left, .logo-right { flex: 1; }
        .logo-left { display: flex; align-items: center; gap: 10px; }
        .logo-right { display: flex; justify-content: flex-end; }
        .logo-left img, .logo-right img { height: 70px; width: auto; }
        
        .logo-text { font-size: 9pt; line-height: 1.2; }
        .logo-text strong { display: block; font-size: 10pt; }

        .title {
            text-align: center;
            font-size: 10.5pt;
            font-weight: bold;
            margin: 5px 0 5px 0;
            text-transform: uppercase;
        }

        .instructions-text {
            margin-bottom: 5px;
            font-size: 9pt;
            text-align: justify;
        }

        .questionnaire-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .questionnaire-table th {
            border: 1pt solid #000;
            padding: 4px 5px;
            text-align: center;
            font-size: 9pt;
            font-weight: bold;
            background-color: #d8d8d8;
            line-height: 1.0;
        }

        .questionnaire-table td {
            border: 1pt solid #000;
            padding: 2px 8px;
            font-size: 9pt;
            vertical-align: middle;
            line-height: 1.1;
        }

        .questionnaire-table .question-id {
            text-align: center;
            width: 5%;
            border-right: 1pt solid #000;
            font-weight: normal;
        }

        .questionnaire-table .question-cell {
            text-align: left;
            width: 45%; 
            padding-left: 5px;
        }

        .questionnaire-table .response-cell {
            text-align: center;
            width: 10%;
            font-size: 11pt;
            font-weight: bold;
        }

        .section-header-row {
            background-color: #f8f9fa;
            text-align: left;
            padding: 8px 10px;
            font-size: 9pt;
            font-weight: bold;
            color: #444;
            border: 1pt solid #000;
        }

        /* Conditional Section Styles */
        .conditional-question-box {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        .cond-options {
            display: flex;
            flex-direction: column;
            border: 1px solid #000;
            width: 80px;
        }
        
        .cond-opt {
            display: flex;
            border-bottom: 1px solid #000;
        }
        .cond-opt:last-child { border-bottom: none; }
        .cond-opt { 
            display: flex; 
            justify-content: space-between;
            padding-left: 5px;
            align-items: center;
            height: 25px;
            font-size: 10pt;
        }
        
        .cond-box {
            border-left: 1px solid #000;
            width: 30px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        @media print {
            body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>
    <!-- P√°gina de Car√°tula -->
    <div class="cover-page">
        <div class="cover-header">
            <div class="cover-data-row">
                <div class="cover-data-label">Fecha de aplicaci√≥n:</div>
                <div style="display: flex; gap: 5px;">
                    <div class="date-container">
                        <div class="box day-box">${day}</div>
                        <div class="box-sublabel">dd</div>
                    </div>
                    <div class="date-container">
                        <div class="box month-box">${month}</div>
                        <div class="box-sublabel">mm</div>
                    </div>
                    <div class="date-container">
                        <div class="box year-box">${year}</div>
                        <div class="box-sublabel">aaaa</div>
                    </div>
                </div>
            </div>
            <div class="cover-data-row">
                <div class="cover-data-label">N√∫mero de Identificaci√≥n<br>del respondiente (ID):</div>
                <div class="box id-box">${responseData.respondent_cedula}</div>
            </div>
        </div>

        <div class="cover-main">
            <div class="green-title" style="color: #2e7d32;">
                Cuestionario de Factores de Riesgo Psicosocial Intralaboral<br>Forma B
            </div>
        </div>

        <div class="cover-footer">
            <div class="footer-logo-left">
                <img src="/cuestionarios/escudo_colombia.png" alt="Escudo de Colombia">
                <span>Ministerio de la Protecci√≥n Social</span>
                <span style="font-weight: normal;">Rep√∫blica de Colombia</span>
            </div>
            <div class="footer-logo-right">
                <img src="/cuestionarios/logo_javeriana.png" alt="Logo Javeriana">
            </div>
        </div>
    </div>
    
    <!-- P√°gina de Instrucciones (Imagen) -->
    <div class="instructions-page-img">
        ${headerHTML}

        <div class="title" style="margin-top: 3rem; margin-bottom: 1rem; font-weight: normal;">
            Cuestionario de Factores de Riesgo Psicosocial Intralaboral - Forma B
        </div>

        <div style="flex: 1; display: flex; align-items: flex-start; justify-content: center; width: 100%; margin-top: 1rem;">
            <img src="${instruccionesB64}" alt="Instrucciones">
        </div>
    </div>

    <!-- P√ÅGINAS DE PREGUNTAS -->

    <!-- P√°gina 1: Preguntas 1-12 -->
    <div class="content-page">
        ${headerHTML}
        ${page1Rows}
    </div>

    <!-- P√°gina 2: Preguntas 13-20 -->
    <div class="content-page">
        ${headerHTML}
        ${page2Rows}
    </div>

    <!-- P√°gina 3: Preguntas 21-37 -->
    <div class="content-page">
        ${headerHTML}
        ${page3Rows}
    </div>

    <!-- P√°gina 4: Preguntas 38-48 -->
    <div class="content-page">
        ${headerHTML}
        ${page4Rows}
    </div>

    <!-- P√°gina 5: Preguntas 49-61 -->
    <div class="content-page">
        ${headerHTML}
        ${page5Rows}
    </div>

    <!-- P√°gina 6: Preguntas 62-75 -->
    <div class="content-page">
        ${headerHTML}
        ${page6Rows}
    </div>

    <!-- P√°gina 7: Preguntas 76-88 -->
    <div class="content-page">
        ${headerHTML}
        ${page7Rows}
    </div>

    <!-- P√°gina 8: Condicional 1 (Clientes) -->
    <div class="content-page">
        ${headerHTML}
        <!-- Seccion Condicional Clientes -->
        ${conditional1Block}
    </div>

</body>
</html>`;
        }

        // === GESTI√ìN DE PDFs EN SERVIDOR (TABLA AVANZADA) ===

        let serverFiles = [];

        function togglePDFSection() {
            const section = document.querySelector('.manage-pdfs-section');
            const responsesDiv = document.getElementById('allResponsesContainer');
            if (responsesDiv) responsesDiv.innerHTML = '';

            section.classList.toggle('hidden');

            if (!section.classList.contains('hidden')) {
                loadPDFList();
                section.scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function loadPDFList() {
            const container = document.getElementById('pdfListContainer');
            if (container) {
                container.innerHTML = '<div class="loading"><div class="spinner"></div>Cargando archivos...</div>';
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/pdfs/intralaborales-b`);
                serverFiles = await response.json();

                if (!container) return;

                if (serverFiles.length === 0) {
                    container.innerHTML = '<div class="error">No hay archivos PDF generados a√∫n.</div>';
                    return;
                }

                let html = `
                    <table class="file-table">
                        <thead>
                            <tr>
                                <th class="checkbox-cell">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)">
                                </th>
                                <th>Archivo</th>
                                <th>Fecha</th>
                                <th>Tama√±o</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                serverFiles.forEach((file, index) => {
                    html += `
                        <tr id="row-${index}">
                            <td class="checkbox-cell">
                                <input type="checkbox" class="file-checkbox" value="${file.filename}" onchange="updateSelection()">
                            </td>
                            <td>üìÑ ${file.filename}</td>
                            <td>${file.created_at}</td>
                            <td>${file.size_kb} KB</td>
                            <td>
                                <div class="file-actions">
                                    <button class="btn btn-primary btn-small" onclick="downloadServerPDF('${file.filename}')">
                                        ‚¨áÔ∏è
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="deleteServerPDF('${file.filename}')" style="background: #dc2626;">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
                updateSelection();

            } catch (error) {
                if (container) container.innerHTML = `<div class="error">Error al cargar lista: ${error.message}</div>`;
            }
        }

        function toggleSelectAll(source) {
            const checkboxes = document.querySelectorAll('.file-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = source.checked;
            });
            updateSelection();
        }

        function updateSelection() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            const count = checkboxes.length;

            const statusDiv = document.getElementById('selectionStatus');
            if (statusDiv) statusDiv.innerText = `${count} archivos seleccionados`;

            const bulkDiv = document.getElementById('bulkActions');
            if (bulkDiv) {
                if (count > 0) {
                    bulkDiv.classList.add('active');
                } else {
                    bulkDiv.classList.remove('active');
                }
            }

            document.querySelectorAll('.file-checkbox').forEach(cb => {
                const row = cb.closest('tr');
                if (cb.checked) row.classList.add('selected-row');
                else row.classList.remove('selected-row');
            });
        }

        function getSelectedFilenames() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        async function downloadServerPDF(filename) {
            window.location.href = `${API_BASE_URL}/api/pdfs/intralaborales-b/${filename}`;
        }

        async function deleteServerPDF(filename) {
            if (!confirm(`¬øBorrar "${filename}"?`)) return;
            try {
                await fetch(`${API_BASE_URL}/api/pdfs/intralaborales-b/${filename}`, { method: 'DELETE' });
                loadPDFList();
            } catch (e) { alert(e.message); }
        }

        async function downloadSelected() {
            const selected = getSelectedFilenames();
            if (selected.length === 0) return;

            if (selected.length === 1) {
                downloadServerPDF(selected[0]);
                return;
            }

            try {
                const button = document.querySelector('#bulkActions button.btn-primary');
                const originalText = button.innerText;
                button.innerText = "‚è≥ Comprimiendo...";

                const response = await fetch(`${API_BASE_URL}/api/pdfs/intralaborales-b/bulk-download`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(selected)
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `reportes_intralaborales_b_seleccionados.zip`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                } else {
                    alert('Error al generar ZIP');
                }
                button.innerText = originalText;
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteSelected() {
            const selected = getSelectedFilenames();
            if (selected.length === 0) return;

            if (!confirm(`¬øEst√°s seguro de BORRAR ${selected.length} archivos seleccionados? esta acci√≥n no se puede deshacer.`)) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/pdfs/intralaborales-b/bulk-delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(selected)
                });

                const result = await response.json();
                loadPDFList();
                alert(`Eliminados: ${result.deleted_count} archivos.`);
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadQuestionnaireData();
        });
    </script>
</body>

</html>